name: Python package

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

jobs:
  build:

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ['ubuntu-latest', 'windows-latest', 'macos-latest']
        python-version: ['3.6', '3.7', '3.8', '3.9', '3.10', '3.11-dev']
        architecture: ['x86', 'x64']
        windows-platformtoolset: ['v143']  # all supported python versions can use this one
        exclude:
          - os: 'ubuntu-latest'
            architecture: 'x86'
          - os: 'macos-latest'
            architecture: 'x86'
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.architecture }}
    - name: Check Python
      run: |
        python --version
        python -c "import struct; print(struct.calcsize('P') * 8)"
    - name: Install libgmp (Ubuntu)
      run: sudo apt-get install -y libgmp-dev
      if: matrix.os == 'ubuntu-latest'
    - name: Setup msbuild (Windows)
      uses: microsoft/setup-msbuild@v1.1
      if: matrix.os == 'windows-latest'
    - name: Install mpir (Windows)
      run: |
        Invoke-WebRequest -Uri "http://mpir.org/mpir-3.0.0.zip" -OutFile "mpir-3.0.0.zip"
        7z x mpir-3.0.0.zip > NUL
        if ("${{ matrix.architecture }}" -eq "x86") { $platform = "Win32" } else { $platform = "x64" }
        msbuild mpir-3.0.0/build.vc14/lib_mpir_gc/lib_mpir_gc.vcxproj /p:Configuration=Release /p:Platform=$platform /p:PlatformToolset=${{ matrix.windows-platformtoolset }} /verbosity:normal
        dir mpir-3.0.0/lib/$platform/Release/
      if: matrix.os == 'windows-latest'
    - name: Install Python dependencies
      run: |
        python -m pip install Cython Sphinx pytest wheel numpy
    - name: Create bdist_wheel (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        ./cddlib-makefile-gmp.ps1
        dir cddlib/lib-src/
        if ("${{ matrix.architecture }}" -eq "x86") { $platform = "Win32" } else { $platform = "x64" }
        python setup.py build build_ext -I"mpir-3.0.0/lib/$platform/Release/" -L"mpir-3.0.0/lib/$platform/Release/"
        python setup.py bdist_wheel
    - name: Create sdist (Non-Windows)
      if: matrix.os != 'windows-latest'
      run: |
        ./cddlib-makefile-gmp.sh
        python -m pip install Cython Sphinx pytest wheel numpy
        python setup.py sdist
    - name: Install
      run: |
        cd dist
        ls
        pip install --pre --no-index --find-links=. pycddlib
        cd ..
    - name: Run test suite
      run: |
        pytest
        cd docs
        make doctest
    - uses: actions/upload-artifact@v3
      if: matrix.os != 'macos-latest'
      with:
        name: dist
        path: dist/*
